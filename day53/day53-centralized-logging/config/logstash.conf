input {
  file {
    path => "/logs/application/*.log"
    start_position => "beginning"
    codec => "json"
    type => "application"
  }
  file {
    path => "/logs/kafka/*.log"
    start_position => "beginning"
    codec => "json"
    type => "kafka"
  }
}

filter {
  if [type] == "application" {
    mutate {
      add_field => { "[@metadata][target_index]" => "streamsocial-logs-%{+YYYY.MM.dd}" }
    }
    
    # Parse JSON from message field if it exists
    if [message] {
      json {
        source => "message"
        target => "parsed"
      }
      
      # Copy parsed fields to root level
      if [parsed] {
        mutate {
          add_field => {
            "level" => "%{[parsed][level]}"
            "logger_name" => "%{[parsed][logger]}"
            "event" => "%{[parsed][event]}"
            "trace_id" => "%{[parsed][trace_id]}"
            "timestamp" => "%{[parsed][timestamp]}"
            "latency_ms" => "%{[parsed][latency_ms]}"
            "error" => "%{[parsed][error]}"
            "content_id" => "%{[parsed][content_id]}"
            "views" => "%{[parsed][views]}"
            "engagement_rate" => "%{[parsed][engagement_rate]}"
          }
        }
        
        # Remove parsed field
        mutate {
          remove_field => ["parsed"]
        }
      }
    }
  }
  
  if [type] == "kafka" {
    mutate {
      add_field => { "[@metadata][target_index]" => "streamsocial-kafka-%{+YYYY.MM.dd}" }
    }
  }

  # Add processing timestamp
  ruby {
    code => "event.set('processed_at', Time.now.utc.iso8601)"
  }

  # Calculate latency if start_time present
  if [start_time] {
    ruby {
      code => "
        begin
          start_time = Time.parse(event.get('start_time'))
          event_time = Time.parse(event.get('timestamp'))
          latency = ((event_time - start_time) * 1000).round(2)
          event.set('latency_ms', latency)
        rescue
        end
      "
    }
  }
  
  # Ensure level is uppercase for consistency
  if [level] {
    mutate {
      uppercase => [level]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][target_index]}"
  }
  
  stdout {
    codec => rubydebug
  }
}
