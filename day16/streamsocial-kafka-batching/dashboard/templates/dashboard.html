<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamSocial - Kafka Batching Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric { text-align: center; margin: 10px 0; }
        .metric-value { font-size: 2.5em; font-weight: bold; color: #667eea; }
        .metric-label { color: #666; font-size: 0.9em; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5a6fd8; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .control-group { display: inline-block; margin: 0 15px; }
        .status { padding: 8px 16px; border-radius: 20px; font-weight: bold; display: inline-block; }
        .status.running { background: #d4edda; color: #155724; }
        .status.stopped { background: #f8d7da; color: #721c24; }
        #throughputChart, #latencyChart { height: 300px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ StreamSocial Kafka Batching Dashboard</h1>
        <p>Real-time Producer Performance & Configuration Management</p>
    </div>

    <div class="container">
        <div class="controls card">
            <h3>Producer Configuration</h3>
            <div class="control-group">
                <label>Configuration Preset:</label>
                <select id="configSelect">
                    <option value="adaptive">Adaptive (Recommended)</option>
                    <option value="low_latency">Low Latency</option>
                    <option value="high_throughput">High Throughput</option>
                    <option value="peak_traffic">Peak Traffic</option>
                </select>
                <button class="btn" onclick="updateConfig()">Apply Config</button>
            </div>
            
            <div class="control-group">
                <span class="status running" id="producerStatus">Producer Running</span>
            </div>
        </div>

        <div class="controls card">
            <h3>Traffic Simulation</h3>
            <div class="control-group">
                <label>Pattern:</label>
                <select id="patternSelect">
                    <option value="steady">Steady Load</option>
                    <option value="spike">Traffic Spikes</option>
                    <option value="ramp">Gradual Ramp</option>
                    <option value="peak">Peak Hours</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Rate (msg/s):</label>
                <input type="number" id="rateInput" value="10000" min="100" max="1000000">
            </div>
            
            <div class="control-group">
                <label>Duration (s):</label>
                <input type="number" id="durationInput" value="60" min="10" max="3600">
            </div>
            
            <button class="btn" onclick="startSimulation()">Start Simulation</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Real-time Metrics</h3>
                <div class="metric">
                    <div class="metric-value" id="messagesPerSec">0</div>
                    <div class="metric-label">Messages / Second</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avgLatency">0ms</div>
                    <div class="metric-label">Average Latency</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="bufferUsage">0%</div>
                    <div class="metric-label">Buffer Usage</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="batchEfficiency">0</div>
                    <div class="metric-label">Batch Efficiency</div>
                </div>
            </div>

            <div class="card">
                <h3>Throughput Timeline</h3>
                <div id="throughputChart"></div>
            </div>

            <div class="card">
                <h3>Latency Distribution</h3>
                <div id="latencyChart"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let throughputData = [];
        let latencyData = [];
        
        // Initialize charts
        const throughputLayout = {
            title: 'Messages per Second',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Messages/sec' },
            margin: { t: 30, r: 30, b: 30, l: 50 }
        };
        
        const latencyLayout = {
            title: 'Latency Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Latency (ms)' },
            margin: { t: 30, r: 30, b: 30, l: 50 }
        };
        
        Plotly.newPlot('throughputChart', [{x: [], y: [], type: 'scatter', mode: 'lines'}], throughputLayout);
        Plotly.newPlot('latencyChart', [{x: [], y: [], type: 'scatter', mode: 'lines'}], latencyLayout);
        
        // Socket event handlers
        socket.on('metrics_update', function(metrics) {
            updateMetricsDisplay(metrics);
            updateCharts(metrics);
        });
        
        socket.on('simulation_complete', function(data) {
            alert('Simulation completed! Messages sent: ' + data.result);
        });
        
        socket.on('simulation_error', function(data) {
            alert('Simulation error: ' + data.error);
        });
        
        function updateMetricsDisplay(metrics) {
            document.getElementById('messagesPerSec').textContent = metrics.messages_per_second || 0;
            document.getElementById('avgLatency').textContent = (metrics.avg_latency || 0) + 'ms';
            document.getElementById('bufferUsage').textContent = (metrics.buffer_usage || 0).toFixed(1) + '%';
            document.getElementById('batchEfficiency').textContent = (metrics.batch_efficiency || 0).toFixed(1);
        }
        
        function updateCharts(metrics) {
            const now = new Date();
            
            // Update throughput chart
            throughputData.push({x: now, y: metrics.messages_per_second || 0});
            if (throughputData.length > 100) throughputData.shift();
            
            Plotly.restyle('throughputChart', {
                x: [throughputData.map(d => d.x)],
                y: [throughputData.map(d => d.y)]
            });
            
            // Update latency chart
            latencyData.push({x: now, y: metrics.avg_latency || 0});
            if (latencyData.length > 100) latencyData.shift();
            
            Plotly.restyle('latencyChart', {
                x: [latencyData.map(d => d.x)],
                y: [latencyData.map(d => d.y)]
            });
        }
        
        function updateConfig() {
            const config = document.getElementById('configSelect').value;
            fetch('/api/config/' + config)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Configuration updated to: ' + config);
                    } else {
                        alert('Error updating configuration: ' + data.message);
                    }
                });
        }
        
        function startSimulation() {
            const pattern = document.getElementById('patternSelect').value;
            const rate = parseInt(document.getElementById('rateInput').value);
            const duration = parseInt(document.getElementById('durationInput').value);
            
            socket.emit('start_simulation', {
                pattern: pattern,
                rate: rate,
                duration: duration
            });
            
            alert('Simulation started! Check the charts for real-time updates.');
        }
    </script>
</body>
</html>
